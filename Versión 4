
# --- 0. LIBRERIAS ---
import dash
from dash import dcc, html, Input, Output, State, dash_table
import dash_bootstrap_components as dbc
import sqlite3
import pandas as pd
import datetime
import openpyxl
import base64
import io
import unicodedata
from openpyxl.utils import get_column_letter
from copy import copy
from io import BytesIO
from google import genai
from docx import Document
from docx.shared import Inches
import plotly.graph_objects as go

# Conexión con API Gemini
API_key_gemini=""
client = genai.Client(api_key=API_key_gemini)

# Conexión con API Airtable
API_key_airtable=""

# --- 1. INICIALIZACIÓN Y NORMALIZACIÓN ---
RUTA_BD_FINANZAS = r'H:\Unidades compartidas\01-Ingeniería\01-Proyectos\Injecución\Códigos python\BDD Proyección certificación.db'
RUTA_BD_OBRA = r'H:\Unidades compartidas\01-Ingeniería\01-Proyectos\Injecución\Códigos python\obra_centralizada.db'

COLOR_FONDO = "#0f0f1a"      # Azul muy oscuro casi negro
COLOR_TARJETA = "#1a1a2e"    # Azul medianoche para las cards
COLOR_ROJO = "#e94560"       # Rojo vibrante para acentos
COLOR_TEXTO = "#e0e0e0"      # Gris muy claro para lectura
COLOR_TEXTO_SEC = "#b3baba"  # Gris para etiquetas secundarias

estilo_card = {
    'backgroundColor': COLOR_TARJETA,
    'borderRadius': '15px',
    'padding': '20px',
    'boxShadow': '0 4px 15px 0 rgba(0, 0, 0, 0.3)',
    'border': 'none',
    'marginBottom': '20px'
}

estilo_titulo = {
    'color': COLOR_TEXTO,
    'fontWeight': '600',
    'letterSpacing': '0.5px'
}

# Estilo unificado para todas las tablas
estilo_tabla_dark = {
    'style_table': {'borderRadius': '15px', 'overflow': 'hidden'},
    'style_header': {
        'backgroundColor': '#121225', # Un poco más oscuro que la card
        'color': COLOR_ROJO,          # Títulos en rojo para resaltar
        'fontWeight': 'bold',
        'border': 'none'
    },
    'style_cell': {
        'backgroundColor': COLOR_TARJETA,
        'color': COLOR_TEXTO,
        'border': '1px solid #2e2e4e', # Bordes internos muy sutiles
        'textAlign': 'left',
        'padding': '10px',
        'fontFamily': 'sans-serif'
    },
    'style_data_conditional': [
        {
            'if': {'state': 'selected'},
            'backgroundColor': 'rgba(233, 69, 96, 0.2)', # Rojo muy transparente al seleccionar
            'border': f'1px solid {COLOR_ROJO}'
        }
    ]
}

# Conexión con la base de datos
def inicializar_base_de_datos_central():
    try:
        # El timeout=20 hace que si la red está lenta, la app espere 20 seg antes de dar error
        conexion = sqlite3.connect(RUTA_BD_OBRA, timeout=20)
        cursor = conexion.cursor()
        
        # Estas líneas (PRAGMA) son vitales para unidades de red como Google Drive
        cursor.execute('PRAGMA journal_mode=WAL;') # Mejora el acceso concurrente
        cursor.execute('PRAGMA synchronous=NORMAL;')
        
        cursor.execute('''CREATE TABLE IF NOT EXISTS sectores 
                          (id INTEGER PRIMARY KEY AUTOINCREMENT, proyecto_id TEXT, tag TEXT, nombre TEXT)''')
        cursor.execute('''CREATE TABLE IF NOT EXISTS tareas 
                          (id INTEGER PRIMARY KEY AUTOINCREMENT, sector_id INTEGER, nombre TEXT, peso_total REAL)''')
        cursor.execute('''CREATE TABLE IF NOT EXISTS subtareas 
                          (id INTEGER PRIMARY KEY AUTOINCREMENT, tarea_id INTEGER, nombre TEXT, peso_proporcional REAL)''')
        cursor.execute('''CREATE TABLE IF NOT EXISTS etapas 
                          (id INTEGER PRIMARY KEY AUTOINCREMENT, subtarea_id INTEGER, nombre TEXT, 
                           peso_dentro_subtarea REAL, certificacion_nro INTEGER DEFAULT 0, responsable_lp TEXT)''')
        
        conexion.commit()
        conexion.close()
    except Exception as e:
        print(f"Error Crítico: No se pudo acceder a la unidad H:. Verifique la conexión. {e}")

inicializar_base_de_datos_central()

def normalizar_texto(texto):
    if not texto: return ""
    texto = str(texto).strip().lower()
    return ''.join(c for c in unicodedata.normalize('NFD', texto) if unicodedata.category(c) != 'Mn')

app = dash.Dash(__name__, external_stylesheets=[dbc.themes.DARKLY], suppress_callback_exceptions=True)

def verificar_consistencia_bdd_finanzas():
    conn = sqlite3.connect(RUTA_BD_FINANZAS, timeout=20)
    cursor = conn.cursor()
    try:
        cursor.execute("PRAGMA table_info(certificacion)")
        columnas_existentes = [col[1] for col in cursor.fetchall()]
        
        # Diccionario con nombres escapados correctamente
        columnas_nuevas = {
            'Mes': "TEXT DEFAULT 'Enero'",
            'Año': "INTEGER DEFAULT 2026",
            'Etiqueta': "TEXT DEFAULT 'Esperando certificación'",
            '[N° Certificación]': "INTEGER DEFAULT 1",
            '[% Avance Previo]': "REAL DEFAULT 0",
            '[% Avance Esperado]': "REAL DEFAULT 0",
            '[% Avance Certificación]': "REAL DEFAULT 0",
            '[% Eficiencia]': "REAL DEFAULT 0",
            '[Monto USD total]': "REAL DEFAULT 0",
            '[Monto USD Mes]': "REAL DEFAULT 0",
            '[Monto USD pendiente]': "REAL DEFAULT 0",
            '[% Anticipo financiero]': "REAL DEFAULT 0"
        }
        
        for col_nombre, definicion in columnas_nuevas.items():
            # Limpiamos corchetes para verificar si existe
            col_check = col_nombre.replace('[', '').replace(']', '')
            if col_check not in columnas_existentes:
                cursor.execute(f"ALTER TABLE certificacion ADD COLUMN {col_nombre} {definicion}")
                print(f"Columna {col_nombre} agregada con éxito.")
            
        conn.commit()
    except Exception as e:
        print(f"Error al migrar la BDD: {e}")
    finally:
        conn.close()

verificar_consistencia_bdd_finanzas()

# --- 2. LAYOUT ---

app.layout = dbc.Container([

    html.Div(style={
        'backgroundColor': COLOR_FONDO,
        'position': 'fixed', 'top': 0, 'left': 0, 'bottom': 0, 'right': 0, 'zIndex': -1
    }),

    dcc.Store(id='activador-refresco', data=0),
    dcc.Store(id='store-excel-base'),
    dcc.Download(id="descargar-excel"),
    dcc.Download(id="descargar-docx-reporte"),
    dcc.Download(id="descargar-docx-prediccion"),
    
    # --- ENCABEZADO / LOGO ---
    dbc.Row([
        dbc.Col(html.Img(src=app.get_asset_url('logo.png'), 
                         style={'height': '70px', 'marginTop': '10px', 'filter': 'drop-shadow(0px 4px 4px rgba(0,0,0,0.5))'}), width=2),
        dbc.Col(html.H2("Ecocontrol App - Avance de obra", 
                        style={'color': COLOR_ROJO, 'fontWeight': '800', 'letterSpacing': '1.5px'}, className="mt-3"), width=10),
    ], className="mb-4 align-items-center"),

    # --- SELECTORES PRINCIPALES ---
    dbc.Row([
        dbc.Col([
            html.Label("Proyecto Activo:", style={'color': COLOR_TEXTO_SEC, 'fontWeight': 'bold', 'fontSize': '14px'}),
            dcc.Dropdown(id='selector-proyecto', placeholder="Seleccione Obra...", style={'backgroundColor': COLOR_TARJETA, 'color':'black', 'border':'none','borderRadius':'8px'}, className="dash-bootstrap"),
        ], width=4),
        dbc.Col([
            html.Label("Responsable LP:", style={'color': COLOR_TEXTO_SEC, 'fontWeight': 'bold', 'fontSize': '14px'}),
            dbc.Input(id="nombre-lp", placeholder="Ingrese su nombre...", type="text", 
                      style={'backgroundColor': COLOR_TARJETA, 'color': 'white', 'border': 'none', 'borderRadius': '8px', 'height': '38px'}),
        ], width=4),
        dbc.Col(dbc.Button("Registrar Nueva Obra", id="abrir-modal-proyecto", 
                           style={'backgroundColor': COLOR_ROJO, 'border': 'none', 'borderRadius': '8px', 'fontWeight': 'bold'}, 
                           className="mt-4 shadow"), width=2),
    ], className="mb-5 align-items-end"),

    # --- INICIO DE PESTAÑAS ---
    dbc.Tabs([
        
        # --- TAB 1: CONFIGURAR SECTORES
        dbc.Tab(label="1. Configurar Sectores", 
                label_style={'color': COLOR_TEXTO_SEC, 'backgroundColor': 'transparent'}, 
                active_label_style={'color': COLOR_ROJO, 'fontWeight': 'bold', 'borderBottom': f'3px solid {COLOR_ROJO}'}, 
                children=[
            html.Br(),
            dbc.Row([
                dbc.Col([
                    html.Div([
                        html.H4("Añadir Sector", style=estilo_titulo),
                        html.Hr(style={'borderColor': 'rgba(255,255,255,0.1)'}),
                        dbc.Input(id="entrada-tag", placeholder="TAG (ej. SEC-01)", className="mb-3", 
                                  style={'backgroundColor': COLOR_FONDO, 'color': 'white', 'border': 'none'}),
                        dbc.Input(id="entrada-nombre-sector", placeholder="Nombre del Sector", className="mb-3", 
                                  style={'backgroundColor': COLOR_FONDO, 'color': 'white', 'border': 'none'}),
                        
                        dbc.Button("Guardar Nuevo Sector", id="boton-guardar-sector", 
                                   style={'backgroundColor': '#252545', 'border': 'none', 'borderRadius': '8px'}, className="w-100 mb-2"),
                        
                        dbc.Button("Confirmar Cambios", id="boton-actualizar-sectores", 
                                   style={'backgroundColor': COLOR_ROJO, 'border': 'none', 'borderRadius': '8px', 'fontWeight': 'bold'}, 
                                   className="w-100 shadow"),
                    ], style=estilo_card),
                ], width=4),
                
                dbc.Col([
                    html.Div([
                        html.H4("TAGs Registrados", style=estilo_titulo), 
                        html.Hr(style={'borderColor': 'rgba(255,255,255,0.1)'}),
                        html.Div(id="div-sectores", className="mt-2", children=[
                            dash_table.DataTable(
                                id='tabla-sectores-editable', 
                                editable=True, 
                                row_deletable=True, 
                                filter_action="native",
                                **estilo_tabla_dark 
                            )
                        ])
                    ], style=estilo_card)
                ], width=8)
            ], className="mt-3")
        ]),
        
        # --- TAB 2: DEFINIR TAREAS Y ETAPAS ---
        dbc.Tab(label="2. Definir Tareas y Etapas", 
                label_style={'color': COLOR_TEXTO_SEC}, 
                active_label_style={'color': COLOR_ROJO, 'fontWeight': 'bold', 'borderBottom': f'3px solid {COLOR_ROJO}'}, 
                children=[
            html.Br(),
            dbc.Row([
                dbc.Col([
                    html.Div([
                        html.H4("Nueva Tarea", style=estilo_titulo),
                        html.P("Respetar nombres de tareas y subtareas definidas por comercial.", 
                               style={'fontSize':'12px', 'color': COLOR_TEXTO_SEC, 'fontStyle':'italic', 'marginBottom':'15px'}),
                        
                        dcc.Dropdown(id='dropdown-sector-para-tarea', placeholder="Elija un TAG...", style={'backgroundColor': COLOR_FONDO, 'color':'black','border':'none','borderRadius':'8px'},className="dash-bootstrap"),
                        html.Br(),
                        dbc.Input(id='entrada-rubro-tarea', placeholder="Ingrese Rubro...", type="text", className="mb-3",
                                  style={'backgroundColor': COLOR_FONDO, 'color': 'white', 'border': 'none'}),
                        
                        html.Label("Subtareas:", style={'color': COLOR_TEXTO, 'fontSize': '14px'}),
                        dcc.Slider(1, 10, 1, value=2, id='deslizador-subtareas', 
                                   marks={i: {'label': str(i), 'style': {'color': COLOR_TEXTO_SEC}} for i in range(1, 11)}),
                        
                        html.Label("Etapas:", style={'color': COLOR_TEXTO, 'fontSize': '14px', 'marginTop': '20px'}),
                        dcc.Slider(1, 5, 1, value=1, id='deslizador-etapas',
                                   marks={i: {'label': str(i), 'style': {'color': COLOR_TEXTO_SEC}} for i in range(1, 6)}),
                        
                        dbc.Button("Insertar Tarea", id="boton-guardar-tarea", color="primary", 
                                   className="w-100 mb-2 mt-4", style={'borderRadius': '8px', 'fontWeight': 'bold'}),
                        
                        dbc.Button("Guardar Cambios", id="boton-actualizar-tabla", 
                                   style={'backgroundColor': COLOR_ROJO, 'border': 'none', 'borderRadius': '8px', 'fontWeight': 'bold'}, 
                                   className="w-100 shadow"),
                        
                        html.Div(id="zona-alertas-pesos", className="mt-3")
                    ], style=estilo_card),
                ], width=4),
                
                dbc.Col([
                    html.Div([
                        html.H4("Estructura de Pesos", style=estilo_titulo), 
                        html.Hr(style={'borderColor': 'rgba(255,255,255,0.1)'}),
                        html.Div(id="div-edicion", className="mt-2", children=[
                            dash_table.DataTable(id='tabla-editable', editable=True, row_deletable=True, filter_action="native",**estilo_tabla_dark)
                        ])
                    ], style=estilo_card)
                ], width=8)
            ], className="mt-3")
        ]),

        # --- TAB 3: PANEL DE AVANCE ---
        dbc.Tab(label="3. Panel de Avance", 
                label_style={'color': COLOR_TEXTO_SEC}, 
                active_label_style={'color': COLOR_ROJO, 'fontWeight': 'bold', 'borderBottom': f'3px solid {COLOR_ROJO}'}, 
                children=[
            html.Br(),
            dbc.Row([
                dbc.Col([
                    html.Div([
                        html.H4("Certificación", style=estilo_titulo),
                        html.Hr(style={'borderColor': 'rgba(255,255,255,0.1)'}),
                        dcc.Dropdown(id='selector-nro-cert', 
                                     options=[{'label': f'Certificación N°{i}', 'value': i} for i in range(1, 13)], 
                                     value=1, style={'backgroundColor': COLOR_FONDO, 'color':'black','border':'none','borderRadius':'8px'},className="dash-bootstrap"),
                        html.Br(),
                        dbc.Button("Actualizar Avance", id="boton-guardar-avance", 
                                   style={'backgroundColor': COLOR_ROJO, 'border': 'none', 'borderRadius': '8px', 'fontWeight': 'bold'}, 
                                   className="w-100 shadow"),
                    ], style=estilo_card)
                ], width=3),
                
                dbc.Col([
                    html.Div([
                        html.H4("Etapas Pendientes", style=estilo_titulo), 
                        html.Hr(style={'borderColor': 'rgba(255,255,255,0.1)'}),
                        html.Div(id="div-avance", className="mt-2", children=[
                            dash_table.DataTable(id='tabla-avance', row_selectable='multi', filter_action="native",**estilo_tabla_dark)
                        ])
                    ], style=estilo_card),
                    
                    html.Div([
                        html.H4("Historial", style=estilo_titulo), 
                        html.Hr(style={'borderColor': 'rgba(255,255,255,0.1)'}),
                        html.Div(id="div-historial", className="mt-2", children=[
                            dash_table.DataTable(id='tabla-historial', row_selectable='multi', filter_action="native",**estilo_tabla_dark)
                        ])
                    ], style=estilo_card, className="mt-4")
                ], width=9)
            ], className="mt-3")
        ]),

        # --- TAB 4: GENERAR CERTIFICADO ---
        dbc.Tab(label="4. Generar Certificado", 
                label_style={'color': COLOR_TEXTO_SEC}, 
                active_label_style={'color': COLOR_ROJO, 'fontWeight': 'bold', 'borderBottom': f'3px solid {COLOR_ROJO}'}, 
                children=[
            html.Br(),
            dbc.Row([
                dbc.Col([
                    html.Div([
                        html.H4("1. Archivo de Trabajo", style=estilo_titulo),
                        dcc.Upload(
                            id='upload-excel-base',
                            children=html.Div(['Arrastra o ', html.A('Selecciona Excel Base', style={'color': COLOR_ROJO})]),
                            style={
                                'width': '100%','height': '60px','lineHeight': '60px',
                                'borderWidth': '1px','borderStyle': 'dashed','borderRadius': '10px',
                                'textAlign': 'center', 'backgroundColor': COLOR_FONDO, 'color': COLOR_TEXTO_SEC
                            },
                            multiple=False
                        ),
                        html.Div(id='output-archivo-cargado', className="mt-2 small text-success"),
                        dbc.Button("Eliminar Archivo", id="boton-eliminar-excel", color="link", size="sm", className="text-danger p-0 mb-3", style={"display": "none"}),
                        
                        html.Hr(style={'borderColor': 'rgba(255,255,255,0.1)'}),
                        
                        html.H4("2. Exportar con Avances", style=estilo_titulo),
                        dcc.Dropdown(id='selector-cert-export', options=[{'label': f'Certificación N°{i}', 'value': i} for i in range(1, 13)], 
                                     placeholder="N° Certificación visible...", style={'backgroundColor': COLOR_FONDO, 'color':'black','border':'none','borderRadius':'8px'},className="dash-bootstrap"),
                        html.Br(),
                        dbc.Button("Completar Excel y Descargar", id="boton-descargar", 
                                   style={'backgroundColor': COLOR_ROJO, 'border': 'none', 'borderRadius': '8px', 'fontWeight': 'bold'}, className="w-100 shadow"),
                    ], style=estilo_card),
                ], width=4),
                
                dbc.Col([
                    html.Div([
                        html.H4("Estado de Exportación", style=estilo_titulo), 
                        html.Hr(style={'borderColor': 'rgba(255,255,255,0.1)'}),
                        html.Div(id="vista-previa-cert", className="mt-2")
                    ], style=estilo_card)
                ], width=8)
            ], className="mt-3")
        ]),

        # --- TAB 5: DASHBOARD VISUAL ---
        dbc.Tab(label="5. Dashboard Visual", 
                label_style={'color': COLOR_TEXTO_SEC}, 
                active_label_style={'color': COLOR_ROJO, 'fontWeight': 'bold', 'borderBottom': f'3px solid {COLOR_ROJO}'}, 
                children=[
            html.Br(),
            html.Div([
                html.H4("Progreso Jerárquico por TAG", 
                        style={'textAlign': 'center', 'color': COLOR_TEXTO, 'fontWeight': 'bold', 'marginTop': '10px'}),
                
                dbc.Row([
                    dbc.Col(
                        dcc.Dropdown(
                            id='selector-tag-dashboard', 
                            placeholder="Seleccione un TAG para ver progreso...", 
                            style={
                                'backgroundColor': COLOR_FONDO, # Un tono más oscuro para el input
                                'color': 'black', 
                                'border': 'none',
                                'borderRadius': '8px'
                            }, className="dash-bootstrap"
                        ), width={'size': 6, 'offset': 3}
                    )
                ], className="mb-4 mt-3"),
                
                html.Hr(style={'borderColor': 'rgba(255,255,255,0.1)', 'marginBottom': '30px'}),
                
                # El contenedor donde se inyectarán las barras de progreso
                dcc.Loading(
                    html.Div(id="contenedor-barras-carga", className="p-2")
                )
            ], style=estilo_card) # Aplica fondo oscuro, bordes redondeados y sombra
        ]),

        # --- TAB 6: ASISTENTE IA ---
        dbc.Tab(label="6. Asistente IA", 
                label_style={'color': COLOR_TEXTO_SEC}, 
                active_label_style={'color': COLOR_ROJO, 'fontWeight': 'bold', 'borderBottom': f'3px solid {COLOR_ROJO}'}, 
                children=[
            html.Br(),
            dbc.Row([
                # Reportes
                dbc.Col([
                    html.Div([
                        html.H5("Generador de Reportes", style=estilo_titulo),
                        html.P("Resumen técnico basado en el avance.", style={'fontSize': '12px', 'color': COLOR_TEXTO_SEC}),
                        dbc.Button("Redactar Informe", id="boton-ia-reporte", style={'backgroundColor': COLOR_ROJO, 'border': 'none'}, className="w-100 mb-3"),
                        dcc.Loading(html.Div(id="salida-ia-reporte", className="small text-muted", style={'whiteSpace': 'pre-wrap', 'maxHeight': '200px', 'overflowY': 'auto'}))
                    ], style=estilo_card),
                ], width=3),
                
                # Remitos
                dbc.Col([
                    html.Div([
                        html.H5("Gestión de Remitos", style=estilo_titulo),
                        html.P("Análisis de imagen/pdf.", style={'fontSize': '12px', 'color': COLOR_TEXTO_SEC}),
                        dcc.Upload(
                            id='upload-remito-ia',
                            children=html.Div(['Importar archivo']),
                            style={
                                'width': '100%','height': '50px','lineHeight': '50px',
                                'borderWidth': '1px','borderStyle': 'dashed','borderRadius': '10px',
                                'textAlign': 'center', 'backgroundColor': COLOR_FONDO, 'color': COLOR_TEXTO_SEC
                            }
                        ),
                        dcc.Loading(html.Div(id="salida-ia-remito", className="mt-2 small text-success"))
                    ], style=estilo_card),
                ], width=3),
                
                # Predicción
                dbc.Col([
                    html.Div([
                        html.H5("Predicción de Obra", style=estilo_titulo),
                        html.P("Seleccione fecha pactada:", style={'fontSize': '11px', 'color': COLOR_TEXTO_SEC}),
                        dcc.DatePickerSingle(
                            id='fecha-entrega-pactada',
                            date=datetime.date.today() + datetime.timedelta(days=30),
                            display_format='DD/MM/YYYY',
                            className="mb-3",
                            style={'width': '100%'}
                        ),
                        dbc.Button("Ver Estado", id="boton-ia-prediccion", style={'backgroundColor': COLOR_ROJO, 'border': 'none'}, className="w-100 mb-2"),
                        dbc.Button("Descargar Justificativo", id="boton-ia-justificativo", style={'backgroundColor': COLOR_ROJO, 'border': 'none'}, className="w-100"),
                        dcc.Loading(html.Div(id="salida-ia-prediccion", className="mt-3 small"))
                    ], style=estilo_card),
                ], width=3),
                
                # Productividad
                dbc.Col([
                    html.Div([
                        html.H5("Productividad", style=estilo_titulo),
                        html.P("Desempeño por Responsable.", style={'fontSize': '12px', 'color': COLOR_TEXTO_SEC}),
                        dbc.Button("Analizar Eficiencia", id="boton-ia-productividad", style={'backgroundColor': COLOR_ROJO, 'border': 'none'}, className="w-100"),
                        dcc.Loading(html.Div(id="salida-ia-productividad", className="mt-3 small"))
                    ], style=estilo_card),
                ], width=3),
            ], className="mt-3")
        ]),

        # --- TAB 7: GESTIÓN FINANCIERA ---
        # --- TAB 7: GESTIÓN FINANCIERA ---
        dbc.Tab(label="7. Gestión Financiera", 
                label_style={'color': COLOR_TEXTO_SEC}, 
                active_label_style={'color': COLOR_ROJO, 'fontWeight': 'bold', 'borderBottom': f'3px solid {COLOR_ROJO}'}, 
                children=[
            html.Br(),
            dbc.Row([
                # Columna de Parámetros
                dbc.Col([
                    html.Div([
                        html.H5("Parámetros Financieros", style=estilo_titulo),
                        html.Hr(style={'borderColor': 'rgba(255,255,255,0.1)'}),
                        
                        # Fila de Mes, Año y N° de Certificación
                        dbc.Row([
                            dbc.Col([
                                dbc.Label("Mes", style={'color': COLOR_TEXTO_SEC, 'fontSize': '12px'}),
                                dcc.Dropdown(id="fin-mes", 
                                           options=[{"label": m, "value": m} for m in ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]], 
                                           value=datetime.datetime.now().strftime('%B'), 
                                           style={'backgroundColor': COLOR_FONDO, 'color':'black', 'border':'none','borderRadius':'8px'},
                                           className="dash-bootstrap")
                            ], width=5),
                            dbc.Col([
                                dbc.Label("Año", style={'color': COLOR_TEXTO_SEC, 'fontSize': '12px'}),
                                dcc.Dropdown(id="fin-anio", 
                                           options=[{"label": str(a), "value": a} for a in [2026, 2027, 2028]], 
                                           value=2026, 
                                           style={'backgroundColor': COLOR_FONDO, 'color':'black', 'border':'none','borderRadius':'8px'},
                                           className="dash-bootstrap"),
                            ], width=4),
                            dbc.Col([
                                dbc.Label("Cert N°", style={'color': COLOR_TEXTO_SEC, 'fontSize': '12px'}),
                                dcc.Dropdown(id="fin-nro-cert-selector", 
                                           options=[{"label": str(i), "value": i} for i in range(1, 25)],
                                           value=1,
                                           style={'backgroundColor': COLOR_FONDO, 'color':'black', 'border':'none','borderRadius':'8px'},
                                           className="dash-bootstrap"),
                            ], width=3),
                        ], className="mb-3"),

                        # Indicador de Eficiencia
                        html.Div([
                            dbc.Label("Eficiencia de Certificación", style={'color': COLOR_TEXTO_SEC, 'fontSize': '12px'}),
                            html.H4(id="met-eficiencia-val", style={'color': '#f1c40f', 'fontWeight': 'bold', 'textAlign': 'center', 'marginBottom': '5px'}),
                            dbc.Progress(id="progreso-eficiencia", value=0, color="warning", style={"height": "8px", "borderRadius": "10px"}, className="mb-3")
                        ], style={'padding': '15px', 'backgroundColor': 'rgba(0,0,0,0.2)', 'borderRadius': '12px', 'marginBottom': '20px', 'border': '1px solid rgba(241, 196, 15, 0.2)'}),

                        # Selector de Estado con Badge
                        dbc.Label("Estado de Certificación", style={'color': COLOR_TEXTO_SEC, 'fontSize': '12px'}),
                        dcc.Dropdown(
                            id="fin-etiqueta", 
                            options=[
                                {"label": "Esperando certificación", "value": "Esperando certificación"},
                                {"label": "Certificación reclamada", "value": "Certificación reclamada"},
                                {"label": "Enviado a facturar", "value": "Enviado a facturar"}
                            ],
                            placeholder="Seleccione estado...",
                            style={'backgroundColor': COLOR_FONDO, 'color':'black', 'border':'none','borderRadius':'8px'},
                            className="dash-bootstrap mb-3"
                        ),
                        html.Div(id="badge-estado-fin", className="text-center mb-3"),
                        
                        # Valores del Contrato
                        dbc.Label("Monto USD Total (Contrato)", style={'color': COLOR_TEXTO_SEC, 'fontSize': '12px'}),
                        dbc.Input(id="fin-monto-total", type="number", className="mb-2",
                                  style={'backgroundColor': COLOR_FONDO, 'color': 'white', 'border': 'none'}),
                        
                        dbc.Label("% Anticipo Financiero", style={'color': COLOR_TEXTO_SEC, 'fontSize': '12px'}),
                        dbc.Input(id="fin-p-anticipo", type="number", className="mb-3",
                                  style={'backgroundColor': COLOR_FONDO, 'color': 'white', 'border': 'none'}),
                        
                        # Bloque de Avances
                        html.Div([
                            dbc.Row([
                                dbc.Col([
                                    dbc.Label("% Acum. Anterior", style={'color': COLOR_TEXTO_SEC, 'fontSize': '11px'}),
                                    dbc.Input(id="fin-p-previo", type="number", readonly=True, 
                                              style={'backgroundColor': '#121225', 'color': '#00d1b2', 'border': 'none', 'fontWeight': 'bold'}),
                                ], width=6),
                                dbc.Col([
                                    dbc.Label("% Avance Esperado", style={'color': COLOR_TEXTO_SEC, 'fontSize': '11px'}),
                                    dbc.Input(id="fin-p-esperado", type="number", placeholder="%",
                                              style={'backgroundColor': COLOR_FONDO, 'color': 'white', 'border': 'none'}),
                                ], width=6),
                            ], className="mb-2"),
                            
                            dbc.Label("% Avance Certificación", style={'color': COLOR_ROJO, 'fontSize': '12px', 'fontWeight': 'bold'}),
                            dbc.Input(id="fin-p-mes-input", type="number", placeholder="Ingrese % del mes", 
                                      style={'backgroundColor': COLOR_FONDO, 'color': 'white', 'border': f'1px solid {COLOR_ROJO}'}),
                        ], className="p-2 mb-3", style={'backgroundColor': 'rgba(255,255,255,0.03)', 'borderRadius': '10px'}),
                        
                        dbc.Button("Guardar Avance Certificación", id="boton-guardar-finanzas", 
                                   style={'backgroundColor': COLOR_ROJO, 'border': 'none', 'fontWeight': 'bold', 'borderRadius': '8px'}, 
                                   className="mt-2 w-100 shadow"),
                        html.Div(id="alerta-guardado-fin", className="mt-2")
                    ], style=estilo_card)
                ], width=4),
                
                # Columna de Métricas y Gráficos
                dbc.Col([
                    dbc.Row([
                        # Tarjeta 1: Progreso Físico Total
                        dbc.Col(html.Div([
                            html.H6("Progreso Físico Total", style={'color': COLOR_TEXTO_SEC, 'fontSize': '13px'}),
                            html.H3(id="met-acumulado-porcentaje", style={'color': '#00d1b2', 'fontWeight': 'bold'}),
                            html.P(id="met-acumulado-usd", style={'fontSize': '12px', 'color': COLOR_TEXTO_SEC})
                        ], style=estilo_card), width=4),
                        
                        # Tarjeta 2: Detalle Mes/Certificación
                        dbc.Col(html.Div([
                            html.H6(id="titulo-met-mes", style={'color': COLOR_TEXTO_SEC, 'fontSize': '13px'}),
                            html.H3(id="met-monto-mes", style={'color': '#209cee', 'fontWeight': 'bold'}),
                            html.P(id="met-porcentaje-mes", style={'fontSize': '12px', 'color': COLOR_TEXTO_SEC})
                        ], style=estilo_card), width=4),
                        
                        # Tarjeta 3: Saldo Pendiente
                        dbc.Col(html.Div([
                            html.H6("Saldo Pendiente de Obra", style={'color': COLOR_TEXTO_SEC, 'fontSize': '13px'}),
                            html.H3(id="met-saldo", style={'color': COLOR_ROJO, 'fontWeight': 'bold'}),
                            html.P("Monto restante del contrato", style={'fontSize': '12px', 'color': COLOR_TEXTO_SEC})
                        ], style=estilo_card), width=4),
                    ], className="mb-2"),
                    
                    # Gráficos de Torta
                    dbc.Row([
                        dbc.Col(html.Div([
                            html.H6("Distribución Financiera", style={'color': COLOR_TEXTO_SEC, 'fontSize': '12px', 'textAlign': 'center'}),
                            dcc.Graph(id="graph-fin-financiero", config={'displayModeBar': False})
                        ], style=estilo_card), width=6),
                        
                        dbc.Col(html.Div([
                            html.H6("Avance Físico de Obra", style={'color': COLOR_TEXTO_SEC, 'fontSize': '12px', 'textAlign': 'center'}),
                            dcc.Graph(id="graph-fin-avance-fisico", config={'displayModeBar': False})
                        ], style=estilo_card), width=6),
                    ]),

                    # Gráfico Global de Cartera
                    dbc.Row([
                        dbc.Col(html.Div([
                            html.H6("Situación Global (Cartera de Proyectos)", style={'color': COLOR_TEXTO_SEC, 'fontSize': '12px', 'textAlign': 'center'}),
                            dcc.Graph(id="graph-fin-global", config={'displayModeBar': False})
                        ], style=estilo_card), width=12)
                    ])
                ], width=8)
            ])
        ]),
    ], style={'border': 'none'}), # CIERRE DE DBC.TABS

    # --- MODAL ---
    dbc.Modal([
        dbc.ModalHeader(dbc.ModalTitle("Registrar Nueva Obra"), 
                        style={'backgroundColor': COLOR_TARJETA, 'color': 'white', 'borderBottom': '1px solid rgba(255,255,255,0.1)'}),
        dbc.ModalBody([
            dbc.Label("Número de Obra", style={'color': COLOR_TEXTO_SEC}),
            dbc.Input(id="nuevo-codigo-proyecto", placeholder="Ej: 2024-001", className="mb-3",
                      style={'backgroundColor': COLOR_FONDO, 'color': 'white', 'border': 'none'}),
            dbc.Label("Nombre Proyecto", style={'color': COLOR_TEXTO_SEC}),
            dbc.Input(id="nuevo-nombre-proyecto", placeholder="Nombre descriptivo...", className="mb-2",
                      style={'backgroundColor': COLOR_FONDO, 'color': 'white', 'border': 'none'}),
        ], style={'backgroundColor': COLOR_TARJETA}),
        dbc.ModalFooter(
            dbc.Button("Guardar Obra", id="boton-crear-proyecto", 
                       style={'backgroundColor': COLOR_ROJO, 'border': 'none', 'borderRadius': '8px', 'padding': '10px 30px'},
                       className="shadow"),
            style={'backgroundColor': COLOR_TARJETA, 'borderTop': 'none'}
        ),
    ], id="modal-proyecto", is_open=False, centered=True),

], fluid=True, style={'backgroundColor': COLOR_FONDO, 'minHeight': '100vh', 'padding': '20px 40px'})

# --- 3. CALLBACKS ---

# C1: Gestión de Archivo Excel Base (Exportación)
@app.callback(
    [Output('output-archivo-cargado', 'children'), Output('store-excel-base', 'data'), Output('boton-eliminar-excel', 'style')],
    [Input('upload-excel-base', 'contents'), Input('boton-eliminar-excel', 'n_clicks')],
    [State('upload-excel-base', 'filename')],
    prevent_initial_call=True
)
def gestionar_excel_base(contents, n_eliminar, filename):
    ctx = dash.callback_context
    if not ctx.triggered: return "", None, {"display": "none"}
    trigger_id = ctx.triggered[0]['prop_id'].split('.')[0]
    if trigger_id == 'upload-excel-base' and contents:
        return f"Archivo cargado: {filename}", contents, {"display": "block"}
    if trigger_id == 'boton-eliminar-excel':
        return "", None, {"display": "none"}
    return dash.no_update, dash.no_update, dash.no_update


# C2: Dashboard Visual de Progreso (Sincronizado con BDD proyección certificaciones)
@app.callback(
    [Output('selector-tag-dashboard', 'options'), Output('contenedor-barras-carga', 'children')],
    [Input('selector-proyecto', 'value'), Input('selector-tag-dashboard', 'value'), Input('activador-refresco', 'data')]
)
# C2: Dashboard Visual de Progreso (Sincronizado con BDD proyección certificaciones)
def actualizar_dashboard_jerarquico(p_id, tag_sel, refresh):
    if not p_id: 
        return [], html.Div("Seleccione un proyecto.", style={'color': COLOR_TEXTO_SEC})
    
    conexion = sqlite3.connect(RUTA_BD_OBRA)
    tags_df = pd.read_sql_query(f"SELECT tag as label, tag as value FROM sectores WHERE proyecto_id='{p_id}'", conexion)
    tags_options = tags_df.to_dict('records')
    
    if not tag_sel: 
        conexion.close()
        return tags_options, html.Div("Seleccione un TAG.", style={'color': COLOR_TEXTO_SEC, 'textAlign': 'center'})
    
    query = f'''
        SELECT t.nombre as tarea, st.id as sub_id, st.nombre as subtarea, e.peso_dentro_subtarea, e.certificacion_nro
        FROM sectores s JOIN tareas t ON s.id = t.sector_id JOIN subtareas st ON t.id = st.tarea_id JOIN etapas e ON st.id = e.subtarea_id 
        WHERE s.tag = '{tag_sel}' AND s.proyecto_id = '{p_id}'
    '''
    df = pd.read_sql_query(query, conexion); conexion.close()
    
    elementos = []
    for tarea, df_t in df.groupby('tarea'):
        num_subs = df_t['sub_id'].nunique()
        subs_w = []
        avance_t = 0.0
        for sub_id, df_s in df_t.groupby('sub_id'):
            prog_s = round(min(df_s[df_s['certificacion_nro'] > 0]['peso_dentro_subtarea'].sum(), 100.0), 1)
            avance_t += (prog_s / 100.0) * (1.0 / num_subs)

            subs_w.append(html.Div([
                html.Label(f"└─ {df_s['subtarea'].iloc[0]} ({prog_s}%)", 
                           style={'marginLeft':'25px', 'color': COLOR_TEXTO_SEC, 'fontSize': '13px'}),
                dbc.Progress(value=prog_s, color="danger", className="mb-3", striped=True,
                             style={'height': '12px', 'backgroundColor': '#252545', 'marginLeft': '25px'})
            ]))

        pct_t = round(avance_t * 100.0, 1)
        elementos.append(html.Div([
            html.H5(f"Tarea: {tarea}", style={'color': COLOR_TEXTO, 'fontWeight': 'bold'}),
            dbc.Progress(label=f"{pct_t}%", value=pct_t, color="primary", 
                         style={"height":"25px", "backgroundColor": "#252545", "fontWeight": "bold"}, className="mb-3"),
            html.Div(subs_w)
        ], style={
            'backgroundColor': COLOR_FONDO, # Un tono más oscuro que la card de fondo para resaltar
            'padding': '20px',
            'borderRadius': '12px',
            'marginBottom': '20px',
            'boxShadow': 'inset 0px 0px 10px rgba(0,0,0,0.5)' # Sombra interna para dar profundidad
        }))

    return tags_options, elementos

# C3: Modal Registro de Nueva Obra
@app.callback(
    [Output("modal-proyecto", "is_open"), Output("nuevo-codigo-proyecto", "value"), Output("nuevo-nombre-proyecto", "value")],
    [Input("abrir-modal-proyecto", "n_clicks"), Input("boton-crear-proyecto", "n_clicks")],
    [State("modal-proyecto", "is_open")], prevent_initial_call=True
)
def alternar_modal(n1, n2, abierto): return not abierto, "", ""

# C4: Motor Principal - Escritura y Gestión (Finanzas + Obra)
@app.callback(
    [Output('selector-proyecto', 'options'), Output('activador-refresco', 'data'), Output('zona-alertas-pesos', 'children')],
    [Input('boton-crear-proyecto', 'n_clicks'), Input('boton-guardar-sector', 'n_clicks'), 
     Input('boton-guardar-tarea', 'n_clicks'), Input('boton-actualizar-sectores', 'n_clicks'),
     Input('boton-actualizar-tabla', 'n_clicks'), Input('boton-guardar-avance', 'n_clicks')],
    [State('nuevo-codigo-proyecto', 'value'), State('nuevo-nombre-proyecto', 'value'), 
     State('selector-proyecto', 'value'), State('entrada-tag', 'value'), 
     State('entrada-nombre-sector', 'value'), State('dropdown-sector-para-tarea', 'value'), 
     State('entrada-rubro-tarea', 'value'), State('deslizador-subtareas', 'value'),
     State('deslizador-etapas', 'value'), State('activador-refresco', 'data'), 
     State('tabla-sectores-editable', 'data'), State('tabla-editable', 'data'), 
     State('tabla-avance', 'data'), State('tabla-avance', 'selected_rows'), 
     State('tabla-historial', 'data'), State('tabla-historial', 'selected_rows'), 
     State('selector-nro-cert', 'value'), State('nombre-lp', 'value')]
)
def motor_principal(n_pr, n_se, n_ta, n_us, n_ut, n_av, cod_num, cod_letra, p_id, tag, n_s_nom, s_id_t, n_t_nom, cant_sub, cant_etap, refresh, d_s, d_t, d_av, s_av, d_hi, s_hi, n_cert, responsable):
    ctx = dash.callback_context
    mensaje_alerta = ""
    nuevo_refresh = (refresh or 0) + 1
    if not ctx.triggered: return obtener_proyectos_red(), refresh, ""
    
    id_btn = ctx.triggered[0]['prop_id'].split('.')[0]
    
    # REGISTRO EN RED (Finanzas)
    if id_btn == 'boton-crear-proyecto' and cod_num:
        conn = sqlite3.connect(RUTA_BD_FINANZAS)
        conn.execute("INSERT OR IGNORE INTO certificacion (Proyecto, Cliente) VALUES (?, ?)", (str(cod_num), str(cod_letra).upper()))
        conn.commit(); conn.close()
        mensaje_alerta = dbc.Alert("Obra registrada en Red", color="success", duration=2000)

    # GESTIÓN TÉCNICA (Obra Centralizada)
    conn_o = sqlite3.connect(RUTA_BD_OBRA)
    try:
        if id_btn == 'boton-guardar-sector' and p_id: 
            conn_o.execute("INSERT INTO sectores (proyecto_id, tag, nombre) VALUES (?, ?, ?)", (p_id, tag, n_s_nom))

        elif id_btn == 'boton-guardar-tarea' and s_id_t:
            cur = conn_o.cursor(); cur.execute("INSERT INTO tareas (sector_id, nombre, peso_total) VALUES (?, ?, ?)", (s_id_t, n_t_nom, 100.0)); t_id = cur.lastrowid
            p_sub, p_etap = 100.0 / cant_sub, 100.0 / (cant_etap if cant_etap > 0 else 1)
            for i in range(1, cant_sub + 1):
                cur.execute("INSERT INTO subtareas (tarea_id, nombre, peso_proporcional) VALUES (?, ?, ?)", (t_id, f"Subtarea {i}", p_sub)); s_id = cur.lastrowid
                for j in range(1, cant_etap + 1): conn_o.execute("INSERT INTO etapas (subtarea_id, nombre, peso_dentro_subtarea) VALUES (?, ?, ?)", (s_id, f"Etapa {j}", p_etap))
        
        elif id_btn == 'boton-actualizar-sectores' and p_id:
            ids_db = [f[0] for f in conn_o.execute(f"SELECT id FROM sectores WHERE proyecto_id='{p_id}'").fetchall()]; ids_tab = [int(f['id']) for f in d_s] if d_s else []
            for id_b in [i for i in ids_db if i not in ids_tab]:
                conn_o.execute(f"DELETE FROM etapas WHERE subtarea_id IN (SELECT id FROM subtareas WHERE tarea_id IN (SELECT id FROM tareas WHERE sector_id={id_b}))")
                conn_o.execute(f"DELETE FROM subtareas WHERE tarea_id IN (SELECT id FROM tareas WHERE sector_id={id_b})"); conn_o.execute(f"DELETE FROM tareas WHERE sector_id={id_b}"); conn_o.execute(f"DELETE FROM sectores WHERE id={id_b}")

        elif id_btn == 'boton-actualizar-tabla' and p_id:
            ids_en_db = [f[0] for f in conn_o.execute(f"SELECT e.id FROM etapas e JOIN subtareas st ON e.subtarea_id=st.id JOIN tareas t ON st.tarea_id=t.id JOIN sectores s ON t.sector_id=s.id WHERE s.proyecto_id='{p_id}'").fetchall()]
            if d_t and len(d_t) > 0:
                df_temp = pd.DataFrame(d_t)
                df_temp['Peso Etapa %'] = pd.to_numeric(df_temp['Peso Etapa %'], errors='coerce').fillna(0)
                df_temp['id_clave'] = df_temp['TAG'].astype(str) + " | " + df_temp['Tarea'].astype(str) + " | " + df_temp['Subtarea'].astype(str)
                if any(round(group['Peso Etapa %'].sum(), 2) != 100.00 for _, group in df_temp.groupby('id_clave')):
                    conn_o.close(); return obtener_proyectos_red(), refresh, dbc.Alert("Error: Pesos deben sumar 100%.", color="danger")
                for f in d_t:
                    conn_o.execute("UPDATE etapas SET nombre=?, peso_dentro_subtarea=? WHERE id=?", (f['Etapa'], f['Peso Etapa %'], f['id']))
                    conn_o.execute("UPDATE subtareas SET nombre=? WHERE id=(SELECT subtarea_id FROM etapas WHERE id=?)", (f['Subtarea'], f['id']))
                mensaje_alerta = dbc.Alert("Cambios guardados.", color="success", duration=3000)

        elif id_btn == 'boton-guardar-avance' and p_id:
            if d_av and s_av:
                for idx in s_av: conn_o.execute("UPDATE etapas SET certificacion_nro=?, responsable_lp=? WHERE id=?", (n_cert, responsable, d_av[idx]['id']))
            if d_hi:
                sel_ids = [d_hi[idx]['id'] for idx in s_hi] if s_hi else []
                for fila in d_hi:
                    if fila['id'] not in sel_ids: conn_o.execute("UPDATE etapas SET certificacion_nro=0, responsable_lp=NULL WHERE id=?", (fila['id'],))
        
        conn_o.commit()
    finally: conn_o.close()
    return obtener_proyectos_red(), nuevo_refresh, mensaje_alerta

# C5: Refrescar Todo (Carga de tablas dinámica por Proyecto)
@app.callback(
    [Output('dropdown-sector-para-tarea', 'options'), Output('tabla-sectores-editable', 'columns'), Output('tabla-sectores-editable', 'data'),
     Output('tabla-editable', 'columns'), Output('tabla-editable', 'data'), Output('tabla-avance', 'columns'), 
     Output('tabla-avance', 'data'), Output('tabla-avance', 'selected_rows'), Output('tabla-historial', 'columns'), 
     Output('tabla-historial', 'data'), Output('tabla-historial', 'selected_rows')],
    [Input('selector-proyecto', 'value'), Input('activador-refresco', 'data')]
)
def refrescar_todo(p_id, refresh):
    if not p_id: return [], [], [], [], [], [], [], [], [], [], []
    conexion = sqlite3.connect(RUTA_BD_OBRA)
    sects = pd.read_sql_query(f"SELECT id as value, tag as label FROM sectores WHERE proyecto_id='{p_id}'", conexion).to_dict('records')
    df_s = pd.read_sql_query(f"SELECT id, tag as TAG, nombre as SECTOR FROM sectores WHERE proyecto_id='{p_id}'", conexion)
    df_e = pd.read_sql_query(f'SELECT e.id, s.tag as TAG, t.nombre as Tarea, st.nombre as Subtarea, e.nombre as Etapa, e.peso_dentro_subtarea as "Peso Etapa %" FROM sectores s JOIN tareas t ON s.id=t.sector_id JOIN subtareas st ON t.id=st.tarea_id JOIN etapas e ON st.id=e.subtarea_id WHERE s.proyecto_id="{p_id}"', conexion)
    df_a = pd.read_sql_query(f'SELECT e.id, s.tag as TAG, t.nombre as Tarea, st.nombre as Subtarea, e.nombre as Etapa FROM sectores s JOIN tareas t ON s.id=t.sector_id JOIN subtareas st ON t.id=st.tarea_id JOIN etapas e ON st.id=e.subtarea_id WHERE s.proyecto_id="{p_id}" AND e.certificacion_nro=0', conexion)
    df_h = pd.read_sql_query(f'SELECT e.id, s.tag as TAG, t.nombre as Tarea, st.nombre as Subtarea, e.nombre as Etapa, e.certificacion_nro as "Cert N°" FROM sectores s JOIN tareas t ON s.id=t.sector_id JOIN subtareas st ON t.id=st.tarea_id JOIN etapas e ON st.id=e.subtarea_id WHERE s.proyecto_id="{p_id}" AND e.certificacion_nro>0', conexion)
    conexion.close()
    return sects, [{"name": i, "id": i} for i in df_s.columns if i!='id'], df_s.to_dict('records'), [{"name": i, "id": i, "editable": True} for i in df_e.columns if i!='id'], df_e.to_dict('records'), [{"name": i, "id": i} for i in df_a.columns if i!='id'], df_a.to_dict('records'), [], [{"name": i, "id": i} for i in df_h.columns if i!='id'], df_h.to_dict('records'), list(range(len(df_h)))

# C6: Exportar Certificación a Excel
@app.callback(
    [Output("vista-previa-cert", "children"), Output("descargar-excel", "data")],
    Input("boton-descargar", "n_clicks"),
    [State("selector-proyecto", "value"), State("selector-proyecto", "options"), State("selector-cert-export", "value"), 
     State("nombre-lp", "value"), State("store-excel-base", "data")],
    prevent_initial_call=True
)
def exportar_certificacion(n, p_id, p_opts, cert_fija, nombre_lp, excel_base_contents):
    if not p_id or not cert_fija: return dbc.Alert("Seleccione Obra y Certificación.", color="warning"), None
    conexion = sqlite3.connect(RUTA_BD_OBRA)
    cod_obra = next((item['label'] for item in p_opts if item['value'] == p_id), "N/A")
    query = f'''
        SELECT st.nombre as subtarea, e.certificacion_nro, SUM(e.peso_dentro_subtarea) as suma_etapas, COUNT(DISTINCT st.id) as cant_unidades
        FROM subtareas st JOIN etapas e ON st.id = e.subtarea_id JOIN tareas t ON st.tarea_id = t.id JOIN sectores s ON t.sector_id = s.id
        WHERE s.proyecto_id = '{p_id}' GROUP BY st.nombre, e.certificacion_nro
    '''
    df_db = pd.read_sql_query(query, conexion); conexion.close()
    if not excel_base_contents: return dbc.Alert("Cargue un archivo base.", color="danger"), None
    
    decoded = base64.b64decode(excel_base_contents.split(',')[1])
    wb = openpyxl.load_workbook(BytesIO(decoded)); ws = wb.active
    
    # Lógica de mapeo en Excel
    mapa_cols = {}
    for c in range(1, 40):
        for r in range(1, 10):
            val = str(ws.cell(row=r, column=c).value or "")
            if "Certificación" in val:
                try: 
                    num = int(''.join(filter(str.isdigit, val)))
                    mapa_cols[num] = c
                except: pass

    for subtarea_nom, df_sub in df_db.groupby('subtarea'):
        sub_norm = normalizar_texto(subtarea_nom); r_excel = None
        for r in range(1, 300):
            if normalizar_texto(ws.cell(row=r, column=2).value) == sub_norm: 
                r_excel = r; break
        if r_excel:
            for cn, c_idx in mapa_cols.items():
                row_cn = df_sub[df_sub['certificacion_nro'] == cn]
                val = row_cn['suma_etapas'].sum() / (100.0 * df_sub['cant_unidades'].iloc[0]) if not row_cn.empty else 0
                ws.cell(row=r_excel, column=c_idx).value = val
                ws.cell(row=r_excel, column=c_idx).number_format = '0.00%'

    output = BytesIO(); wb.save(output); output.seek(0)
    return dbc.Alert(f"Certificado {cod_obra} listo.", color="success"), dcc.send_bytes(output.read(), f"Certificado_{cod_obra}.xlsx")

# --- CALLBACKS IA ---

# C7: Informe Técnico IA
@app.callback(
    [Output("salida-ia-reporte", "children"), Output("descargar-docx-reporte", "data")],
    Input("boton-ia-reporte", "n_clicks"),
    [State("selector-proyecto", "value"), State("selector-proyecto", "options"), State("nombre-lp", "value")],
    prevent_initial_call=True
)
def callback_reporte_ia(n, p_id, p_opts, lp):
    if not p_id: return "Seleccione proyecto.", None
    cod_obra = next((item['label'] for item in p_opts if item['value'] == p_id), "Obra")
    conexion = sqlite3.connect(RUTA_BD_OBRA)
    df = pd.read_sql_query(f"SELECT t.nombre, e.nombre FROM etapas e JOIN subtareas st ON e.subtarea_id=st.id JOIN tareas t ON st.tarea_id=t.id JOIN sectores s ON t.sector_id=s.id WHERE s.proyecto_id='{p_id}' AND e.certificacion_nro>0", conexion); conexion.close()
    if df.empty: return "Sin avances.", None
    
    resp = client.models.generate_content(model="gemini-2.0-flash", contents=f"Redacta informe técnico Ecocontrol. Obra: {cod_obra}. Responsable: {lp}. Datos: {df.to_string()}")
    doc = Document(); doc.add_heading(f'Informe {cod_obra}', 0); doc.add_paragraph(resp.text)
    out = BytesIO(); doc.save(out); out.seek(0)
    return "Informe generado.", dcc.send_bytes(out.read(), f"Informe_{cod_obra}.docx")

# C8: Lectura de Remitos IA
@app.callback(
    Output("salida-ia-remito", "children"),
    Input("upload-remito-ia", "contents"),
    State("upload-remito-ia", "filename"),
    prevent_initial_call=True
)
def callback_remito_ia(contents, filename):
    if not contents: return ""
    image_bytes = base64.b64decode(contents.split(',')[1])
    prompt = "Extrae Cantidad, Descripción y Proveedor de este remito en una tabla Markdown."
    response = client.models.generate_content(model="gemini-2.0-flash", contents=[prompt, {"mime_type": "image/jpeg", "data": image_bytes}])
    return dcc.Markdown(response.text)

# C9: Predicción y Justificativo IA
@app.callback(
    [Output("salida-ia-prediccion", "children"), Output("boton-ia-justificativo", "style"), Output("descargar-docx-prediccion", "data")],
    [Input("boton-ia-prediccion", "n_clicks"), Input("boton-ia-justificativo", "n_clicks")],
    [State("selector-proyecto", "value"), State("selector-proyecto", "options"), State("fecha-entrega-pactada", "date")],
    prevent_initial_call=True
)
def callback_prediccion_ia(n_pre, n_jus, p_id, p_opts, fecha_ent):
    ctx = dash.callback_context
    trig = ctx.triggered[0]['prop_id'].split('.')[0]
    conexion = sqlite3.connect(RUTA_BD_OBRA)
    df = pd.read_sql_query(f"SELECT certificacion_nro FROM etapas e JOIN subtareas st ON e.subtarea_id=st.id JOIN tareas t ON st.tarea_id=t.id JOIN sectores s ON t.sector_id=s.id WHERE s.proyecto_id='{p_id}'", conexion); conexion.close()
    avance = (len(df[df['certificacion_nro']>0]) / len(df)) * 100 if not df.empty else 0
    
    if trig == "boton-ia-prediccion":
        res = client.models.generate_content(model="gemini-2.0-flash", contents=f"Avance {avance:.1f}%. Objetivo {fecha_ent}. ¿Llegamos? Responde breve.")
        return res.text, {"display": "block", "marginTop": "10px"}, None
    
    if trig == "boton-ia-justificativo":
        res = client.models.generate_content(model="gemini-2.0-flash", contents=f"Genera plan de mitigación para obra con {avance:.1f}% de avance y fecha {fecha_ent}.")
        doc = Document(); doc.add_heading('Plan de Mitigación', 0); doc.add_paragraph(res.text)
        out = BytesIO(); doc.save(out); out.seek(0)
        return dash.no_update, dash.no_update, dcc.send_bytes(out.read(), "Plan_Mitigacion.docx")
    return dash.no_update, dash.no_update, dash.no_update

# C10: Análisis de Productividad IA
@app.callback(
    Output("salida-ia-productividad", "children"),
    Input("boton-ia-productividad", "n_clicks"),
    State("selector-proyecto", "value"),
    prevent_initial_call=True
)
def callback_productividad_ia(n, p_id):
    if not p_id: return "Seleccione proyecto."
    conexion = sqlite3.connect(RUTA_BD_OBRA)
    df = pd.read_sql_query(f"SELECT responsable_lp, COUNT(*) as completas FROM etapas e JOIN subtareas st ON e.subtarea_id=st.id JOIN tareas t ON st.tarea_id=t.id JOIN sectores s ON t.sector_id=s.id WHERE s.proyecto_id='{p_id}' AND e.certificacion_nro>0 GROUP BY responsable_lp", conexion); conexion.close()
    if df.empty: return "No hay datos de responsables."
    res = client.models.generate_content(model="gemini-2.0-flash", contents=f"Analiza el rendimiento del equipo Ecocontrol: {df.to_string()}")
    return dcc.Markdown(res.text)

# --- FUNCIONES AUXILIARES PARA GESTIÓN FINANCIERA ---

import unicodedata

def crear_badge_financiero(estado):
    if not estado:
        estado = "Esperando estado"
    
    # Mapeo directo sin normalización compleja para evitar errores de coincidencia
    colores = {
        "Esperando certificación": "#f39c12",   # Naranja
        "Certificación reclamada": "#e74c3c",   # Rojo
        "Enviado a facturar": "#27ae60"          # Verde
    }
    
    color = colores.get(estado, "#1263ab") # Celeste por defecto si no coincide
    
    return dbc.Badge(
        estado.upper(), 
        style={
            "backgroundColor": color, 
            "padding": "12px", 
            "width": "100%",
            "fontSize": "14px",
            "boxShadow": "0 4px 10px rgba(0,0,0,0.3)",
            "borderRadius": "10px",
            "border": "none",
            "color": "white"
        }
    )

# C11: Carga de datos, Actualización de Métricas y Gráficos
@app.callback(
    [Output("fin-monto-total", "value"),
     Output("fin-p-anticipo", "value"),
     Output("fin-p-previo", "value"), # Este es el % Acumulado Anterior
     Output("fin-p-mes-input", "value"),
     Output("badge-estado-fin", "children"),
     Output("met-acumulado-porcentaje", "children"),
     Output("met-acumulado-usd", "children"),
     Output("titulo-met-mes", "children"),
     Output("met-monto-mes", "children"),
     Output("met-porcentaje-mes", "children"),
     Output("met-saldo", "children"),
     Output("graph-fin-financiero", "figure"), 
     Output("graph-fin-avance-fisico", "figure"),
     Output("graph-fin-global", "figure"),
     Output("fin-etiqueta", "value"),
     Output("fin-p-esperado", "value"),
     Output("met-eficiencia-val", "children"),
     Output("progreso-eficiencia", "value")],
    [Input("selector-proyecto", "value"),
     Input("fin-nro-cert-selector", "value"), 
     Input("fin-mes", "value"),
     Input("fin-anio", "value"),
     Input("alerta-guardado-fin", "children")]
)
def cargar_y_actualizar_panel_financiero(p_id, n_cert, mes, anio, _):
    def fmt_reg(valor):
        texto = "{:,.2f}".format(valor or 0)
        return "USD " + texto.replace(",", "X").replace(".", ",").replace("X", ".")

    fig_vacia = go.Figure().update_layout(template='plotly_dark', paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)')
    
    if not p_id:
        return (0, 0, 0, 0, crear_badge_financiero("Esperando certificación"), "0,00%", "USD 0,00", 
                "Certificación", "USD 0,00", "0,00%", "USD 0,00", fig_vacia, fig_vacia, fig_vacia, 
                "Esperando certificación", 0, "0%", 0)

    p_id_str = str(p_id)
    conn_fin = sqlite3.connect(RUTA_BD_FINANZAS, timeout=20)
    
    try:
        # 1. DATOS CONTRACTUALES (Usamos MAX para asegurar que traiga el valor base definido)
        query_base = "SELECT MAX([Monto USD total]), MAX([% Anticipo financiero]), MAX(IFNULL([% Avance Previo], 0)) FROM certificacion WHERE Proyecto = ?"
        res_b = conn_fin.execute(query_base, (p_id_str,)).fetchone()
        
        m_total = res_b[0] or 0
        p_ant_dec = res_b[1] or 0
        p_base_contrato = round(res_b[2], 4)

        # 2. CÁLCULO ACUMULADO ANTERIOR (Base + Suma de certificaciones N < Actual)
        query_hist = "SELECT SUM([% Avance Certificación]) FROM certificacion WHERE Proyecto = ? AND [N° Certificación] < ?"
        res_hist = conn_fin.execute(query_hist, (p_id_str, n_cert)).fetchone()
        p_meses_anteriores = round(res_hist[0] or 0, 4)
        
        # Este es el valor que se muestra en el campo "% Acum. Anterior"
        p_acum_anterior_valor = round(p_base_contrato + p_meses_anteriores, 4)

        # 3. DATOS DE LA CERTIFICACIÓN ACTUAL
        query_act = "SELECT [% Avance Certificación], Etiqueta, IFNULL([% Avance Esperado], 0), IFNULL([% Eficiencia], 0) FROM certificacion WHERE Proyecto = ? AND [N° Certificación] = ?"
        res_act = conn_fin.execute(query_act, (p_id_str, n_cert)).fetchone()
        
        p_mes_real = round(res_act[0], 4) if res_act else 0
        etiqueta_actual = res_act[1] if res_act else "Esperando certificación"
        p_esperado_bd = round(res_act[2] * 100, 2) if res_act else 0
        eficiencia_val = round(res_act[3] * 100, 1) if res_act else 0

        # 4. PROGRESO FÍSICO TOTAL (Acumulado Anterior + Mes Actual)
        p_fisico_global = round(p_acum_anterior_valor + p_mes_real, 4)

        # 5. CÁLCULOS FINANCIEROS
        m_ant_usd = m_total * p_ant_dec
        m_certificable = m_total - m_ant_usd
        m_mes_usd = m_certificable * p_mes_real
        m_acum_usd = m_certificable * p_fisico_global
        m_saldo_pend = m_total - m_ant_usd - m_acum_usd

        # 6. GRÁFICOS (Manteniendo lógica de sumatoria de columnas)
        df_all = pd.read_sql_query("SELECT SUM([Monto USD total]) as t, SUM([Monto USD Mes]) as c, SUM([Monto USD pendiente]) as p FROM certificacion", conn_fin)
        sum_t, sum_c, sum_p = (df_all['t'].iloc[0] or 0), (df_all['c'].iloc[0] or 0), (df_all['p'].iloc[0] or 0)
        
        fig_pie_fin = go.Figure(data=[go.Pie(labels=["Anticipo", "Certificado", "Saldo Pend."], values=[m_ant_usd, m_acum_usd, max(0, m_saldo_pend)], hole=0.4, marker_colors=["#232FCD", "#317361", "#b70f0f"])]).update_layout(template='plotly_dark', paper_bgcolor='rgba(0,0,0,0)', showlegend=False, height=250, margin=dict(t=0,b=0,l=0,r=0))
        fig_pie_fisico = go.Figure(data=[go.Pie(labels=["Ejecutado", "Pendiente"], values=[p_fisico_global, max(0, 1 - p_fisico_global)], hole=0.4, marker_colors=["#317361", "#232FCD"])]).update_layout(template='plotly_dark', paper_bgcolor='rgba(0,0,0,0)', showlegend=False, height=250, margin=dict(t=0,b=0,l=0,r=0))
        fig_glo = go.Figure(data=[go.Bar(name='Total Contratos', x=['Cartera'], y=[sum_t], marker_color='#232FCD'), go.Bar(name='Total Certificado', x=['Cartera'], y=[sum_c], marker_color='#317361'), go.Bar(name='Saldo Pendiente', x=['Cartera'], y=[sum_p], marker_color='#e94560')]).update_layout(barmode='group', template='plotly_dark', paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)', height=280)

        return (
            m_total, round(p_ant_dec * 100, 2), round(p_acum_anterior_valor * 100, 2), 
            round(p_mes_real * 100, 2), crear_badge_financiero(etiqueta_actual),
            f"{round(p_fisico_global * 100, 2)}%".replace(".", ","), fmt_reg(m_acum_usd),
            f"Certificación N°{n_cert}", fmt_reg(m_mes_usd), f"{round(p_mes_real * 100, 2)}%",
            fmt_reg(m_saldo_pend), fig_pie_fin, fig_pie_fisico, fig_glo, 
            etiqueta_actual, p_esperado_bd, f"{eficiencia_val}%", eficiencia_val
        )
    finally:
        conn_fin.close()

# C12: Guardado
@app.callback(
    Output("alerta-guardado-fin", "children"),
    Input("boton-guardar-finanzas", "n_clicks"),
    [State("selector-proyecto", "value"),
     State("fin-nro-cert-selector", "value"),
     State("fin-monto-total", "value"),
     State("fin-p-anticipo", "value"),
     State("fin-p-mes-input", "value"),
     State("fin-p-esperado", "value"),
     State("fin-etiqueta", "value"),
     State("fin-mes", "value"),
     State("fin-anio", "value"),
     State("fin-p-previo", "value")], # Recibe el acumulado anterior calculado por C11
    prevent_initial_call=True
)
def guardar_avance_financiero_final(n, p_id, n_cert, m_total, p_ant, p_mes, p_esp, etiqueta, mes, anio, p_acum_ant_input):
    if not p_id: return dbc.Alert("Seleccione un proyecto", color="warning")
    
    p_id_str = str(p_id)
    conn = sqlite3.connect(RUTA_BD_FINANZAS, timeout=20)
    try:
        cur = conn.cursor()
        
        # 1. Recuperar datos del contrato original
        cur.execute("SELECT Cliente, MAX([% Avance Previo]) FROM certificacion WHERE Proyecto=? GROUP BY Proyecto", (p_id_str,))
        res = cur.fetchone()
        cliente_nombre = res[0] if res else "S/D"
        p_base_contrato = res[1] if res else 0

        # 2. Cálculos decimales
        p_ant_dec = (p_ant or 0) / 100.0
        p_mes_dec = (p_mes or 0) / 100.0
        p_esp_dec = (p_esp or 0) / 100.0
        p_prev_dec = (p_acum_ant_input or 0) / 100.0 # Proviene de fin-p-previo
        
        # Eficiencia
        eficiencia = (p_mes_dec / p_esp_dec) if p_esp_dec > 0 else 0
        
        # Montos
        m_ant = m_total * p_ant_dec
        m_certificable = m_total - m_ant
        m_mes_usd = m_certificable * p_mes_dec
        
        # El saldo pendiente debe restar lo acumulado hasta hoy (Previo + Mes Actual)
        m_pendiente_actual = m_total - m_ant - (m_certificable * (p_prev_dec + p_mes_dec))

        # 3. Guardado seguro
        cur.execute("DELETE FROM certificacion WHERE Proyecto=? AND [N° Certificación]=?", (p_id_str, n_cert))
        
        query_ins = '''INSERT INTO certificacion 
                   (Proyecto, Cliente, [N° Certificación], [Monto USD total], [% Anticipo financiero], 
                    [Monto USD anticipo], [Monto USD certificable], Etiqueta, 
                    [% Avance Certificación], [% Avance Esperado], [% Eficiencia], 
                    [Monto USD Mes], [Monto USD pendiente], [% Avance Previo], Mes, Año)
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)'''
        
        cur.execute(query_ins, (
            p_id_str, cliente_nombre, n_cert, m_total, p_ant_dec, m_ant, m_certificable, 
            etiqueta, p_mes_dec, p_esp_dec, eficiencia, m_mes_usd, 
            max(0, m_pendiente_actual), p_base_contrato, mes, anio
        ))
        
        conn.commit()
        return dbc.Alert(f"Certificación N°{n_cert} guardada.", color="success", duration=2500)
    finally:
        conn.close()

# --- FUNCIONES AUXILIARES ---

def obtener_proyectos_red():
    try:
        conn = sqlite3.connect(RUTA_BD_FINANZAS)
        query = """
            SELECT Proyecto as value, 
                   (Proyecto || '-A-' || MAX(IFNULL(Cliente, 'S/D'))) as label 
            FROM certificacion 
            WHERE Proyecto IS NOT NULL AND Proyecto != ''
            GROUP BY Proyecto
        """
        df = pd.read_sql_query(query, conn)
        conn.close()
        return df.to_dict('records')
    except:
        return []

def normalizar_texto(texto):
    if not texto: return ""
    texto = str(texto).strip().lower()
    return ''.join(c for c in unicodedata.normalize('NFD', texto) if unicodedata.category(c) != 'Mn')

if __name__ == '__main__':
    app.run(debug=True)
